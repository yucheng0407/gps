/*jshint expr:true eqnull:true */
/**
 *
 * Backbone.DeepModel v0.10.4
 *
 * Copyright (c) 2013 Charles Davison, Pow Media Ltd
 *
 * https://github.com/powmedia/backbone-deep-model
 * Licensed under the MIT License
 */

/**
 * Underscore mixins for deep objects
 *
 * Based on https://gist.github.com/echong/3861963
 */
/**
 * Main source
 */
/**
 * Underscore mixins for deep objects
 *
 * Based on https://gist.github.com/echong/3861963
 */
(function(t,e){var i,n,r,s,u,o,a=[].slice
r=function(i){var n,s
return!t.isObject(i)||t.isFunction(i)?i:i instanceof e.Collection||i instanceof e.Model?i:t.isElement(i)?i:t.isDate(i)?new Date(i.getTime()):t.isRegExp(i)?RegExp(i.source,(""+i).replace(/.*\//,"")):(s=t.isArray(i||t.isArguments(i)),n=function(t,e,i){return s?t.push(r(e)):t[i]=r(e),t},t.reduce(i,n,s?[]:{}))},o=function(e){return null==e?!1:(e.prototype==={}.prototype||e.prototype===Object.prototype)&&t.isObject(e)&&!t.isArray(e)&&!t.isFunction(e)&&!t.isDate(e)&&!t.isRegExp(e)&&!t.isArguments(e)},n=function(e){return t.filter(t.keys(e),function(t){return o(e[t])})},i=function(e){return t.filter(t.keys(e),function(i){return t.isArray(e[i])})},u=function(e,r,s){var o,a,h,c,f,l,p,d,g,v
if(null==s&&(s=20),0>=s)return console.warn("_.deepExtend(): Maximum depth of recursion hit."),t.extend(e,r)
for(l=t.intersection(n(e),n(r)),a=function(t){return r[t]=u(e[t],r[t],s-1)},p=0,g=l.length;g>p;p++)f=l[p],a(f)
for(c=t.intersection(i(e),i(r)),o=function(i){return r[i]=t.union(e[i],r[i])},d=0,v=c.length;v>d;d++)h=c[d],o(h)
return t.extend(e,r)},s=function(){var e,i,n,s
if(n=2<=arguments.length?a.call(arguments,0,s=arguments.length-1):(s=0,[]),i=arguments[s++],t.isNumber(i)||(n.push(i),i=20),n.length<=1)return n[0]
if(0>=i)return t.extend.apply(this,n)
for(e=n.shift();n.length>0;)e=u(e,r(n.shift()),i)
return e},t.mixin({deepClone:r,isBasicObject:o,basicObjects:n,arrays:i,deepExtend:s})}).call(this,_,Backbone),function(t){"function"==typeof define&&define.amd?define(["underscore","backbone"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone")):t(_,Backbone)}(function(t,e){function i(e){var n={},r=u.keyPathSeparator
for(var s in e){var o=e[s]
if(!o||o.constructor!==Object&&o.constructor!==Array||t.isEmpty(o))n[s]=o
else{var a=i(o)
for(var h in a){var c=a[h]
n[s+r+h]=c}}}return n}function n(e,i,n){for(var r=u.keyPathSeparator,s=i?i.split(r):[],o=e,a=0,h=s.length;h>a;a++){if(n&&!t.has(o,s[a]))return!1
if(o=o[s[a]],null==o&&h-1>a&&(o={}),void 0===o)return n?!0:o}return n?!0:o}function r(e,i,n,r){r=r||{}
for(var s=u.keyPathSeparator,o=i?i.split(s):[],a=e,h=0,c=o.length;c>h&&void 0!==a;h++){var f=o[h]
if(h===c-1)r.unset?delete a[f]:a[f]=n
else{if(void 0===a[f]||!t.isObject(a[f])){var l=o[h+1]
a[f]=/^\d+$/.test(l)?[]:{}}a=a[f]}}}function s(t,e){r(t,e,null,{unset:!0})}var u=e.Model.extend({constructor:function(e,i){var n,r=e||{}
this.cid=t.uniqueId("c"),this.attributes={},i&&i.collection&&(this.collection=i.collection),i&&i.parse&&(r=this.parse(r,i)||{}),(n=t.result(this,"defaults"))&&(r=t.deepExtend({},n,r)),this.set(r,i),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(e){return t.deepClone(this.attributes)},get:function(t){return n(this.attributes,t)},set:function(e,o,a){var h,c,f,l,p,d,g,v
if(null==e)return this
if("object"==typeof e?(c=e,a=o||{}):(c={})[e]=o,a||(a={}),!this._validate(c,a))return!1
f=a.unset,p=a.silent,l=[],d=this._changing,this._changing=!0,d||(this._previousAttributes=t.deepClone(this.attributes),this.changed={}),v=this.attributes,g=this._previousAttributes,this.idAttribute in c&&(this.id=c[this.idAttribute]),c=i(c)
for(h in c)o=c[h],t.isEqual(n(v,h),o)||l.push(h),t.isEqual(n(g,h),o)?s(this.changed,h):r(this.changed,h,o),f?s(v,h):r(v,h,o)
if(!p){l.length&&(this._pending=!0)
for(var b=u.keyPathSeparator,y={},m=0,_=l.length;_>m;m++){var e=l[m]
y.hasOwnProperty(e)&&y[e]||(y[e]=!0,this.trigger("change:"+e,this,n(v,e),a))
for(var x=e.split(b),A=x.length-1;A>0;A--){var E=t.first(x,A).join(b),k=E+b+"*"
y.hasOwnProperty(k)&&y[k]||(y[k]=!0,this.trigger("change:"+k,this,n(v,E),a)),y.hasOwnProperty(E)&&y[E]||(y[E]=!0,this.trigger("change:"+E,this,n(v,E),a))}}}if(d)return this
if(!p)for(;this._pending;)this._pending=!1,this.trigger("change",this,a)
return this._pending=!1,this._changing=!1,this},clear:function(e){var n={},r=i(this.attributes)
for(var s in r)n[s]=void 0
return this.set(n,t.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!t.isEmpty(this.changed):void 0!==n(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?i(this.changed):!1
var n=this._changing?this._previousAttributes:this.attributes
e=i(e),n=i(n)
var r,s=!1
for(var u in e)t.isEqual(n[u],r=e[u])||((s||(s={}))[u]=r)
return s},previous:function(t){return null!=t&&this._previousAttributes?n(this._previousAttributes,t):null},previousAttributes:function(){return t.deepClone(this._previousAttributes)}})
return u.keyPathSeparator=".",e.DeepModel=u,"undefined"!=typeof module&&(module.exports=u),e})
