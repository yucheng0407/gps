// Rivets.js
// version: 0.5.13
// author: Michael Richards
// license: MIT
(function(){var t,i,e=function(t,i){return function(){return t.apply(i,arguments)}},n=[].slice,s={}.hasOwnProperty,r=function(t,i){function e(){this.constructor=t}for(var n in i)s.call(i,n)&&(t[n]=i[n])
return e.prototype=i.prototype,t.prototype=new e,t.__super__=i.prototype,t},o=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i
return-1}
if(t={},i=window.jQuery||window.Zepto,!h)var h={TEXT_NODE:3}
String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),t.Binding=function(){function i(t,i,n,s,r,o){var h,l,u,a
if(this.view=t,this.el=i,this.type=n,this.key=s,this.keypath=r,this.options=null!=o?o:{},this.update=e(this.update,this),this.unbind=e(this.unbind,this),this.bind=e(this.bind,this),this.publish=e(this.publish,this),this.sync=e(this.sync,this),this.set=e(this.set,this),this.eventHandler=e(this.eventHandler,this),this.formattedValue=e(this.formattedValue,this),!(this.binder=this.view.binders[n])){a=this.view.binders
for(h in a)u=a[h],"*"!==h&&-1!==h.indexOf("*")&&(l=RegExp("^"+h.replace("*",".+")+"$"),l.test(n)&&(this.binder=u,this.args=RegExp("^"+h.replace("*","(.+)")+"$").exec(n),this.args.shift()))}this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function&&(this.binder={routine:this.binder}),this.formatters=this.options.formatters||[],this.model=this.key?this.view.models[this.key]:this.view.models}return i.prototype.formattedValue=function(t){var i,e,s,r,o,h
for(h=this.formatters,r=0,o=h.length;o>r;r++)e=h[r],i=e.split(/\s+/),s=i.shift(),e=this.model[s]instanceof Function?this.model[s]:this.view.formatters[s],(null!=e?e.read:void 0)instanceof Function?t=e.read.apply(e,[t].concat(n.call(i))):e instanceof Function&&(t=e.apply(null,[t].concat(n.call(i))))
return t},i.prototype.eventHandler=function(t){var i,e
return e=(i=this).view.config.handler,function(n){return e.call(t,this,n,i)}},i.prototype.set=function(t){var i
return t=t instanceof Function&&!this.binder["function"]?this.formattedValue(t.call(this.model)):this.formattedValue(t),null!=(i=this.binder.routine)?i.call(this,this.el,t):void 0},i.prototype.sync=function(){return this.set(this.options.bypass?this.model[this.keypath]:this.view.config.adapter.read(this.model,this.keypath))},i.prototype.publish=function(){var i,e,s,r,o,h,l,u,a
for(r=t.Util.getInputValue(this.el),l=this.formatters.slice(0).reverse(),o=0,h=l.length;h>o;o++)e=l[o],i=e.split(/\s+/),s=i.shift(),(null!=(u=this.view.formatters[s])?u.publish:void 0)&&(r=(a=this.view.formatters[s]).publish.apply(a,[r].concat(n.call(i))))
return this.view.config.adapter.publish(this.model,this.keypath,r)},i.prototype.bind=function(){var t,i,e,n,s,r,o,h,l
if(null!=(r=this.binder.bind)&&r.call(this,this.el),this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync()),null!=(o=this.options.dependencies)?o.length:void 0){for(h=this.options.dependencies,l=[],n=0,s=h.length;s>n;n++)t=h[n],/^\./.test(t)?(e=this.model,i=t.substr(1)):(t=t.split("."),e=this.view.models[t.shift()],i=t.join(".")),l.push(this.view.config.adapter.subscribe(e,i,this.sync))
return l}},i.prototype.unbind=function(){var t,i,e,n,s,r,o,h,l
if(null!=(r=this.binder.unbind)&&r.call(this,this.el),this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),null!=(o=this.options.dependencies)?o.length:void 0){for(h=this.options.dependencies,l=[],n=0,s=h.length;s>n;n++)t=h[n],/^\./.test(t)?(e=this.model,i=t.substr(1)):(t=t.split("."),e=this.view.models[t.shift()],i=t.join(".")),l.push(this.view.config.adapter.unsubscribe(e,i,this.sync))
return l}},i.prototype.update=function(t){var i
return null==t&&(t={}),this.key?t[this.key]&&(this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),this.model=t[this.key],this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync())):this.sync(),null!=(i=this.binder.update)?i.call(this,t):void 0},i}(),t.ComponentBinding=function(i){function n(i,n,s){var r,h,l,u,a
for(this.view=i,this.el=n,this.type=s,this.unbind=e(this.unbind,this),this.bind=e(this.bind,this),this.update=e(this.update,this),this.locals=e(this.locals,this),this.component=t.components[this.type],this.attributes={},this.inflections={},u=this.el.attributes||[],h=0,l=u.length;l>h;h++)r=u[h],a=r.name,o.call(this.component.attributes,a)>=0?this.attributes[r.name]=r.value:this.inflections[r.name]=r.value}return r(n,i),n.prototype.sync=function(){},n.prototype.locals=function(t){var i,e,n,s,r,o,h,l,u
null==t&&(t=this.view.models),r={},l=this.inflections
for(e in l)for(i=l[e],u=i.split("."),o=0,h=u.length;h>o;o++)s=u[o],r[e]=(r[e]||t)[s]
for(e in t)n=t[e],null==r[e]&&(r[e]=n)
return r},n.prototype.update=function(t){var i
return null!=(i=this.componentView)?i.update(this.locals(t)):void 0},n.prototype.bind=function(){var i,e
return null!=this.componentView?null!=(e=this.componentView)?e.bind():void 0:(i=this.component.build.call(this.attributes),(this.componentView=new t.View(i,this.locals(),this.view.options)).bind(),this.el.parentNode.replaceChild(i,this.el))},n.prototype.unbind=function(){var t
return null!=(t=this.componentView)?t.unbind():void 0},n}(t.Binding),t.TextBinding=function(t){function i(t,i,n,s,r,o){this.view=t,this.el=i,this.type=n,this.key=s,this.keypath=r,this.options=null!=o?o:{},this.sync=e(this.sync,this),this.formatters=this.options.formatters||[],this.model=this.key?this.view.models[this.key]:this.view.models}return r(i,t),i.prototype.binder={routine:function(t,i){return t.data=null!=i?i:""}},i.prototype.sync=function(){return i.__super__.sync.apply(this,arguments)},i}(t.Binding),t.View=function(){function i(i,n,s){var r,o,h,l,u,a,d,p,c
for(this.els=i,this.models=n,this.options=null!=s?s:{},this.update=e(this.update,this),this.publish=e(this.publish,this),this.sync=e(this.sync,this),this.unbind=e(this.unbind,this),this.bind=e(this.bind,this),this.select=e(this.select,this),this.build=e(this.build,this),this.componentRegExp=e(this.componentRegExp,this),this.bindingRegExp=e(this.bindingRegExp,this),void 0===this.els.length&&(this.els=[this.els]),d=["config","binders","formatters"],u=0,a=d.length;a>u;u++){if(o=d[u],this[o]={},this.options[o]){p=this.options[o]
for(r in p)h=p[r],this[o][r]=h}c=t[o]
for(r in c)h=c[r],null==(l=this[o])[r]&&(l[r]=h)}this.build()}return i.prototype.bindingRegExp=function(){var t
return t=this.config.prefix,t?RegExp("^data-"+t+"-"):/^data-/},i.prototype.componentRegExp=function(){var t,i
return RegExp("^"+(null!=(t=null!=(i=this.config.prefix)?i.toUpperCase():void 0)?t:"RV")+"-")},i.prototype.build=function(){var i,e,s,r,l,u,a,d,p,c=this
for(this.bindings=[],u=[],i=this.bindingRegExp(),s=this.componentRegExp(),e=function(i,e,n,s){var r,o,h,l,u,a,d,p,f,b
return a={},f=function(){var t,i,e,n
for(e=s.split("|"),n=[],t=0,i=e.length;i>t;t++)p=e[t],n.push(p.trim())
return n}(),r=function(){var t,i,e,n
for(e=f.shift().split("<"),n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push(o.trim())
return n}(),d=r.shift(),b=d.split(/\.|:/),a.formatters=f,a.bypass=-1!==d.indexOf(":"),b[0]?l=b.shift():(l=null,b.shift()),u=b.join("."),(h=r.shift())&&(a.dependencies=h.split(/\s+/)),c.bindings.push(new t[i](c,e,n,l,u,a))},l=function(r){var a,d,p,f,b,v,g,y,m,w,x,k,E,N,V,T,R,B,C,U,j,_,O,D,A,L,F,H,Q,$,S,P
if(o.call(u,r)<0){if(r.nodeType===h.TEXT_NODE){if(y=t.TextTemplateParser,(b=c.config.templateDelimiters)&&(N=y.parse(r.data,b)).length&&(1!==N.length||N[0].type!==y.types.text))for(x=N[0],w=2<=N.length?n.call(N,1):[],r.data=x.value,0===x.type?r.data=x.value:e("TextBinding",r,null,x.value),R=0,j=w.length;j>R;R++)E=w[R],k=document.createTextNode(E.value),r.parentNode.appendChild(k),1===E.type&&e("TextBinding",k,null,E.value)}else if(s.test(r.tagName))V=r.tagName.replace(s,"").toLowerCase(),c.bindings.push(new t.ComponentBinding(c,r,V))
else if(null!=r.attributes){for(F=r.attributes,B=0,_=F.length;_>B;B++)if(a=F[B],i.test(a.name)){if(V=a.name.replace(i,""),!(p=c.binders[V])){H=c.binders
for(v in H)T=H[v],"*"!==v&&-1!==v.indexOf("*")&&(m=RegExp("^"+v.replace("*",".+")+"$"),m.test(V)&&(p=T))}if(p||(p=c.binders["*"]),p.block){for(Q=r.childNodes,C=0,O=Q.length;O>C;C++)g=Q[C],u.push(g)
d=[a]}}for($=d||r.attributes,U=0,D=$.length;D>U;U++)a=$[U],i.test(a.name)&&(V=a.name.replace(i,""),e("Binding",r,V,a.value))}for(S=r.childNodes,P=[],L=0,A=S.length;A>L;L++)f=S[L],P.push(l(f))
return P}},p=this.els,a=0,d=p.length;d>a;a++)r=p[a],l(r)},i.prototype.select=function(t){var i,e,n,s,r
for(s=this.bindings,r=[],e=0,n=s.length;n>e;e++)i=s[e],t(i)&&r.push(i)
return r},i.prototype.bind=function(){var t,i,e,n,s
for(n=this.bindings,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.bind())
return s},i.prototype.unbind=function(){var t,i,e,n,s
for(n=this.bindings,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.unbind())
return s},i.prototype.sync=function(){var t,i,e,n,s
for(n=this.bindings,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.sync())
return s},i.prototype.publish=function(){var t,i,e,n,s
for(n=this.select(function(t){return t.binder.publishes}),s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.publish())
return s},i.prototype.update=function(t){var i,e,n,s,r,o,h
null==t&&(t={})
for(e in t)n=t[e],this.models[e]=n
for(o=this.bindings,h=[],s=0,r=o.length;r>s;s++)i=o[s],h.push(i.update(t))
return h},i}(),t.TextTemplateParser=function(){function t(){}return t.types={text:0,binding:1},t.parse=function(t,i){var e,n,s,r,o,h,l
for(h=[],r=t.length,e=0,n=0;r>n;){if(e=t.indexOf(i[0],n),0>e){h.push({type:this.types.text,value:t.slice(n)})
break}if(e>0&&e>n&&h.push({type:this.types.text,value:t.slice(n,e)}),n=e+2,e=t.indexOf(i[1],n),0>e){o=t.slice(n-2),s=h[h.length-1],(null!=s?s.type:void 0)===this.types.text?s.value+=o:h.push({type:this.types.text,value:o})
break}l=t.slice(n,e).trim(),h.push({type:this.types.binding,value:l}),n=e+2}return h},t}(),t.Util={bindEvent:function(t,e,n){return null!=window.jQuery?(t=i(t),null!=t.on?t.on(e,n):t.bind(e,n)):null!=window.addEventListener?t.addEventListener(e,n,!1):(e="on"+e,t.attachEvent(e,n))},unbindEvent:function(t,e,n){return null!=window.jQuery?(t=i(t),null!=t.off?t.off(e,n):t.unbind(e,n)):null!=window.removeEventListener?t.removeEventListener(e,n,!1):(e="on"+e,t.detachEvent(e,n))},getInputValue:function(t){var e,n,s,r
if(null!=window.jQuery)switch(t=i(t),t[0].type){case"checkbox":return t.is(":checked")
default:return t.val()}else switch(t.type){case"checkbox":return t.checked
case"select-multiple":for(r=[],n=0,s=t.length;s>n;n++)e=t[n],e.selected&&r.push(e.value)
return r
default:return t.value}}},t.binders={enabled:function(t,i){return t.disabled=!i},disabled:function(t,i){return t.disabled=!!i},checked:{publishes:!0,bind:function(i){return t.Util.bindEvent(i,"change",this.publish)},unbind:function(i){return t.Util.unbindEvent(i,"change",this.publish)},routine:function(t,i){var e
return"radio"===t.type?t.checked=(null!=(e=t.value)?""+e:void 0)===(null!=i?""+i:void 0):t.checked=!!i}},unchecked:{publishes:!0,bind:function(i){return t.Util.bindEvent(i,"change",this.publish)},unbind:function(i){return t.Util.unbindEvent(i,"change",this.publish)},routine:function(t,i){var e
return"radio"===t.type?t.checked=(null!=(e=t.value)?""+e:void 0)!==(null!=i?""+i:void 0):t.checked=!i}},show:function(t,i){return t.style.display=i?"":"none"},hide:function(t,i){return t.style.display=i?"none":""},html:function(t,i){return t.innerHTML=null!=i?i:""},value:{publishes:!0,bind:function(i){return t.Util.bindEvent(i,"change",this.publish)},unbind:function(i){return t.Util.unbindEvent(i,"change",this.publish)},routine:function(t,e){var n,s,r,h,l,u,a
if(null!=window.jQuery){if(t=i(t),(null!=e?""+e:void 0)!==(null!=(h=t.val())?""+h:void 0))return t.val(null!=e?e:"")}else if("select-multiple"===t.type){if(null!=e){for(a=[],s=0,r=t.length;r>s;s++)n=t[s],a.push(n.selected=(l=n.value,o.call(e,l)>=0))
return a}}else if((null!=e?""+e:void 0)!==(null!=(u=t.value)?""+u:void 0))return t.value=null!=e?e:""}},text:function(t,i){return null!=t.innerText?t.innerText=null!=i?i:"":t.textContent=null!=i?i:""},"if":{block:!0,bind:function(t){var i,e
return null==this.marker?(i=["data",this.view.config.prefix,this.type].join("-").replace("--","-"),e=t.getAttribute(i),this.marker=document.createComment(" rivets: "+this.type+" "+e+" "),t.removeAttribute(i),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)):void 0},unbind:function(){var t
return null!=(t=this.nested)?t.unbind():void 0},routine:function(i,e){var n,s,r,o,h
if(!!e==(null==this.nested)){if(e){r={},h=this.view.models
for(n in h)s=h[n],r[n]=s
return o={binders:this.view.options.binders,formatters:this.view.options.formatters,config:this.view.options.config},(this.nested=new t.View(i,r,o)).bind(),this.marker.parentNode.insertBefore(i,this.marker.nextSibling)}return i.parentNode.removeChild(i),this.nested.unbind(),delete this.nested}},update:function(t){var i
return null!=(i=this.nested)?i.update(t):void 0}},unless:{block:!0,bind:function(i){return t.binders["if"].bind.call(this,i)},unbind:function(){return t.binders["if"].unbind.call(this)},routine:function(i,e){return t.binders["if"].routine.call(this,i,!e)},update:function(i){return t.binders["if"].update.call(this,i)}},"on-*":{"function":!0,unbind:function(i){return this.handler?t.Util.unbindEvent(i,this.args[0],this.handler):void 0},routine:function(i,e){return this.handler&&t.Util.unbindEvent(i,this.args[0],this.handler),t.Util.bindEvent(i,this.args[0],this.handler=this.eventHandler(e))}},"each-*":{block:!0,bind:function(t){var i,e,n,s,r
if(null==this.marker)return i=["data",this.view.config.prefix,this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],t.removeAttribute(i),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)
for(r=this.iterated,n=0,s=r.length;s>n;n++)e=r[n],e.bind()},unbind:function(t){var i,e,n,s,r
if(null!=this.iterated){for(s=this.iterated,r=[],e=0,n=s.length;n>e;e++)i=s[e],r.push(i.unbind())
return r}},routine:function(i,e){var n,s,r,o,h,l,u,a,d,p,c,f,b,v,g,y,m,w,x,k
if(u=this.args[0],e=e||[],this.iterated.length>e.length)for(m=Array(this.iterated.length-e.length),b=0,g=m.length;g>b;b++)s=m[b],f=this.iterated.pop(),f.unbind(),this.marker.parentNode.removeChild(f.els[0])
for(k=[],r=v=0,y=e.length;y>v;r=++v)if(l=e[r],n={},l&&(l.$index=r+1),n[u]=l,null==this.iterated[r]){w=this.view.models
for(h in w)l=w[h],null==n[h]&&(n[h]=l)
d=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,a={binders:this.view.options.binders,formatters:this.view.options.formatters,config:{}},x=this.view.options.config
for(o in x)c=x[o],a.config[o]=c
a.config.preloadData=!0,p=i.cloneNode(!0),f=new t.View(p,n,a),f.bind(),this.iterated.push(f),k.push(this.marker.parentNode.insertBefore(p,d.nextSibling))}else this.iterated[r].models[u]!==l?k.push(this.iterated[r].update(n)):(this.iterated[r].update(n),k.push(void 0))
return k},update:function(t){var i,e,n,s,r,o,h,l
i={}
for(e in t)n=t[e],e!==this.args[0]&&(i[e]=n)
for(h=this.iterated,l=[],r=0,o=h.length;o>r;r++)s=h[r],l.push(s.update(i))
return l}},"class-*":function(t,i){var e
return e=" "+t.className+" ",!i==(-1!==e.indexOf(" "+this.args[0]+" "))?t.className=i?""+t.className+" "+this.args[0]:e.replace(" "+this.args[0]+" "," ").trim():void 0},"*":function(t,i){return i?t.setAttribute(this.type,i):t.removeAttribute(this.type)}},t.components={},t.config={preloadData:!0,handler:function(t,i,e){return this.call(t,i,e.view.models)}},t.formatters={},t.factory=function(i){return i._=t,i.binders=t.binders,i.components=t.components,i.formatters=t.formatters,i.config=t.config,i.configure=function(i){var e,n
null==i&&(i={})
for(e in i)n=i[e],t.config[e]=n},i.bind=function(i,e,n){var s
return null==e&&(e={}),null==n&&(n={}),s=new t.View(i,e,n),s.bind(),s}},"object"==typeof exports?t.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(i){return t.factory(this.rivets=i),i}):t.factory(this.rivets={})}).call(this)
